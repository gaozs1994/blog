westernpost-public：develop/finance-2025.06.26
westernpost-common：develop/finance-2025.06.26
westernpost-woms-task：develop/finance-2025.06.26
westernpost-wms：develop/finance-2025.06.26
westernpost-rabbitmq: release2.0.0
wpglb-fms：develop/finance-2025.06.26
wpglb-fms-task：develop/finance-2025.06.26
wpglb-bms-pipeline-task：develop/finance-2025.06.26



(一)财务&渠道迭代
任务 1：【WMS-开票管理】新增海外仓开票金额校验。
    a. 申请开票校验终版账单金额跟输入的开票金额总和是否相等。
    b. 开票明细校验每行费用项总和是否等于开票金额。
任务 2：【WMS-头程账单开票管理】增加导出功能。
    a. 列表发票类型数据-增值税发票增加：普通发票/专用发票显示。
    b. 增加“导出开票信息”功能：导出当前列表页的所有字段数据。
    c. 增加“导出开票明细”功能：导出开票明细以及开票主数据。
    d. 以上两个导出功能超出5w条数据走导出任务功能。
任务 3：【FMS-物流成本明细】新增“变更签约主体”功能及其他调整。
    a. 列表查询、导出、导出任务新增字段:数据来源、是否推凭。
    c. 调整物流成本跑数任务，数据来源为人工调整时不再更新成本明细，是否推凭为否时删除汇总后不再生成。
    b. 新增【变更供应商签约主体】功能，检查是否允许变更后发送MQ消息消费变更以及重新汇总。
    c. 新增【导入确认成本】功能，检查是否为预估成本以及推凭状态047，发送MQ消息消费变更以及重新汇总。
    d. 新增【是否推凭调整】功能，检查是否为预估成本以及推凭状态047，发送MQ消息消费变更以及重新汇总。
    e. 物流成本汇总后不再更新推凭参考号、账单数量、金额，改为推凭操作更新。

(二)日常工作
任务 1: 物流费用自动对账任务，对账中异常问题。
    a. 提交SQL工单重新对账，已反馈产品，下个迭代排查异常原因。


```sql
-- 物流成本明细表，添加字段
ALTER TABLE bfi_logistics_cost_detail
ADD COLUMN data_source TINYINT NOT NULL DEFAULT 0 COMMENT '数据来源：0-系统拉取，1-人工调整',
ADD COLUMN is_push TINYINT NOT NULL DEFAULT 1 COMMENT '是否推凭：1-是，0-否';

-- 添加索引
ALTER TABLE bfi_logistics_cost_detail
ADD INDEX idx_data_source (data_source),
ADD INDEX idx_is_push (is_push);


-- 按钮权限：是否推凭调整/变更供应商签约主体/导入确认成本
INSERT INTO `westernpost_cas`.`user_right` (`um_id`,`ur_code`,`ur_name`,`ur_name_en`,`ur_name_ru`,`ur_description`,`ur_url`,`ur_sort`,`ur_type`,`ur_module`,`ur_icon`,`ur_common`,`ur_sales_version`,`ur_name_th`,`ur_operate_type`,`app_id`,`cloud_link`,`datav_token`) VALUES (10042,'logisticsCostDetail.updateSupplierContractEntity','变更供应商签约主体','Change the contracting entity of the supplier','','变更供应商签约主体','',21,1,'','',0,'','','2',7,0,'');
INSERT INTO `westernpost_cas`.`user_right` (`um_id`,`ur_code`,`ur_name`,`ur_name_en`,`ur_name_ru`,`ur_description`,`ur_url`,`ur_sort`,`ur_type`,`ur_module`,`ur_icon`,`ur_common`,`ur_sales_version`,`ur_name_th`,`ur_operate_type`,`app_id`,`cloud_link`,`datav_token`) VALUES (10042,'logisticsCostDetail.isPushAdjust','是否推凭调整','Whether to support the adjustment','','是否推凭调整','',22,1,'','',0,'','','2',7,0,'');
INSERT INTO `westernpost_cas`.`user_right` (`um_id`,`ur_code`,`ur_name`,`ur_name_en`,`ur_name_ru`,`ur_description`,`ur_url`,`ur_sort`,`ur_type`,`ur_module`,`ur_icon`,`ur_common`,`ur_sales_version`,`ur_name_th`,`ur_operate_type`,`app_id`,`cloud_link`,`datav_token`) VALUES (10042,'logisticsCostDetail.importConfirmedCost','导入确认成本','Import confirmed cost','','导入确认成本','',23,1,'','',0,'','','2',7,0,'');

-- 创建表：物流成本明细-导入确认成本记录
CREATE TABLE `bfi_logistics_cost_detail_import_confirm_task` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `task_id` varchar(50) DEFAULT NULL COMMENT '任务ID',
  `order_code` varchar(100) DEFAULT NULL COMMENT '订单号',
  `tracking_number` varchar(100) DEFAULT NULL COMMENT '跟踪号',
	`confirm_amount` DECIMAL(20,6) DEFAULT NULL COMMENT '确认成本',
  `state` int DEFAULT '0' COMMENT '处理状态 0-待处理 1-处理中 2-已处理 3-异常',
  `remark` text COMMENT '失败原因',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `create_user_id` int NOT NULL DEFAULT '0' COMMENT '创建人',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  KEY `idx_task_id` (`task_id`) USING BTREE,
  KEY `idx_order_code` (`order_code`) USING BTREE,
  KEY `idx_tracking_number` (`tracking_number`) USING BTREE
) ENGINE=InnoDB COMMENT='物流成本明细-导入确认成本记录';

-- 创建表：物流成本明细-导入推凭调整记录
CREATE TABLE `bfi_logistics_cost_detail_push_adjust_task` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `task_id` varchar(50) DEFAULT NULL COMMENT '任务ID',
	`label_type` int NOT NULL DEFAULT '0' COMMENT '标签类型 1.西邮标签 2.代卖标签 3.退件标签 0 无标签 4.第三方订单',
  `order_code` varchar(100) DEFAULT NULL COMMENT '订单号',
  `tracking_number` varchar(100) DEFAULT NULL COMMENT '跟踪号',
  `reconciliation_invoice_no` varchar(100) DEFAULT NULL COMMENT '核账发票号',
  `state` int DEFAULT '0' COMMENT '处理状态 0-待处理 1-处理中 2-已处理 3-异常',
  `remark` text COMMENT '失败原因',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `create_user_id` int NOT NULL DEFAULT '0' COMMENT '创建人',
  `update_time` datetime DEFAULT NULL COMMENT '更新时间',
  PRIMARY KEY (`id`) USING BTREE,
  KEY `idx_task_id` (`task_id`) USING BTREE,
  KEY `idx_label_type` (`label_type`) USING BTREE,
  KEY `idx_order_code` (`order_code`) USING BTREE,
  KEY `idx_tracking_number` (`tracking_number`) USING BTREE
) ENGINE=InnoDB COMMENT='物流成本明细-导入推凭调整记录';

-- 物流成本明细：审批时间调整为datetime类型
ALTER TABLE wpglb_fms.bfi_logistics_cost_detail
MODIFY COLUMN audit_time DATETIME DEFAULT NULL COMMENT '审核时间';

```

物流成本明细
- 关联公司=财务仓库关联公司
- 签约主体=供应商签约主体

物流成本汇总
- 供应商签约主体=签约主体(明细)

汇总维度
- 业务类型+费用类型+关联公司（签约主体）+客户代码+应付月份+仓库+发票号+供应商+币种+账单所属月份(完成时间(yyyy-MM))



- 物流成本跑数调整
    - 数据来源：人工调整
        - 预估成本->预估成本，不更新明细
        - 预估成本->确认成本，不更新明细
        - 确认成本->确认成本，不更新明细
        - 新增预估成本、确认成本？，更新明细
    - 是否推凭：否
        - 重新汇总，对明细进行过滤，判断是否推凭为否时，删除汇总后不再生成汇总单
    - tip