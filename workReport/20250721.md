(一)财务&渠道迭代
任务 1：【WMS-导出任务】等模块导出任务迁移重构。
    a. 已完成出库费用_导出列表、物流收入_收入数据汇总导出、仓租收入_导出
任务 2：【FMS系统-所有涉及到业务类型的模块】业务类型赋值规则更新。
    a. 业务类型查询条件逻辑优化，从同一个枚举内取值。
    b. 跑数任务新增业务类型“菜鸟_退件(Cainiao_return)”的赋值逻辑。
    c. 历史数据处理“菜鸟_退件(Cainiao_return)”业务类型。

(二)IT值班群问题
任务 1：【WMS-头程账单管理】已开票账单还是处于已确认状态。
    排查原因：完成开票操作校验账单币种金额明细全部开票才会更新状态。
任务 2：【WMS-账单汇总】转运页签包裹实重翻倍。
    排查原因：转运费用查询SQL关联fba_order_tray转运托盘订单表存在两条记录，导致笛卡尔积翻倍。
任务 3：【FMS-物流成本】跑数任务报错问题。
    排查原因：17号上线费用精细化相关对账功能，核账发票号更新为空导致空指针异常。
    解决方案：跑数任务判断核账发票号为空时自动赋值为空串，并将相关明细汇总删除。
任务 4：【OMS-物流索赔】导入数据报错问题。
    排查原因：Excel索赔图片解析错误问题，调整解析位置即可。
任务 5：【OMS-物流索赔】新增上网异常、其他时没带上物流渠道ID。
    排查原因：没有索赔资料要求数据，新增时这两种类型没有校验资料要求。
    解决方案：前端加上资料要求拉取、产品提供资料要求提SQL工单新增，物流渠道为空的历史数据提交SQL工单更新。
任务 6：【WMS-库内索赔】明细审批弹窗点击下一条、上一条无效。
    排查原因：前端input赋值标签被误删了，已反馈给对应开发，改后已上线。

- westernpost-common：develop/finance-2025.07.31
- wpglb-fms：develop/finance-2025.07.31
- westernpost-woms-task:develop/finance-2025.07.31

- WMS
    - ✅物流收入_导出
    - ✅物流收入_导出财务数据
        - 目前走的是Common,注释掉woms-task任务即可
    - ✅订单查询_导出列表
    - ❌订单查询_导出横排明细
    - ❌订单查询_导出竖排明细
    - ❌订单查询_导出转运详情
    - ✅物流费用_西邮标签_导出
    - ✅物流费用_代卖标签_导出
    - ✅物流费用_退件标签_导出
    - ✅物流费用_承运商退件_导出
    - ✅物流费用_导出财务数据
    - ✅出库费用_导出列表
    - ✅增值费用_其他操作费用_导出列表
    - ✅海外仓账单汇总(客户&仓库)_导出
        - 从woms-task迁移到common,并改成分批查询
- FMS
    - ✅物流收入_导出
        - 目前走的是Common,注释掉woms-task任务即可
    - ✅头程收入汇总_导出
    - ✅头程收入明细_导出
    - ✅海外仓收入汇总
    - ✅客户&仓库汇总
    - ✅操作费收入_导出
    - ✅增值费收入_导出
    - ✅第三方订单导出列表-物流收入
    - ✅第三方订单导出列表-库内收入
    - ✅头程成本汇总_导出
    - ✅头程成本明细_导出
    - ✅物流成本汇总
    - ✅物流成本明细
        - 改前端提示、限制条数
    - ✅物流收入_收入数据汇总导出
    - ✅仓租收入_导出
    - ✅物流索赔收入_导出
    - ✅库内索赔收入_导出
    - ✅卡车收入_导出
    - ✅操作成本汇总_导出
    - ✅卸柜费成本明细_导出
    - 卡车成本汇总_导出
    - 卡车成本明细_导出
    - 仓租成本汇总_导出
         - 目前无导出任务，目前只有实时导出。


```html
<div class="modal fade" id="exportTaskDataModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" set-lan="html:generateExportTask">生成导出任务</h4>
            </div>
            <div class="modal-body">
                <div class="form-group form-inline">
                    <label><span id="exportTaskButtonName" set-lan="html:export1QDataTips"> 数据超过1000条时会生成导出任务，</span><span
                            set-lan="html:exportTaskTips">将按如下条件导出数据：</span></label>
                </div>
                <div class="form-group form-inline">
                    <div class="form-control" style="height: auto;" id="exportTaskInfo">

                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger btn-rounded pull-center" id="exportTaskBtn" onclick="doExportTaskData()"
                        set-lan="html:generateExportTask">生成导出任务
                </button>
                <button class="btn btn-default btn-rounded" data-dismiss="modal" set-lan="html:cancel">取消</button>
            </div>
        </div>
    </div>
</div>
<!-- 生成导出任务成功 -->
<div class="modal fade" id="exportTaskLinkModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" set-lan="html:generateExportTask">生成导出任务</h4>
            </div>
            <div class="modal-body">
                <div class="form-group form-inline">
                    <label set-lan="html:exportTaskSuccessTip">已生成导出任务，请前往：</label>
                    <a class="classLinkA" href="javascript:void(0)" onClick="linkExportTask()"
                       id="exportTaskLinkCode"></a>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default btn-rounded" data-dismiss="modal" set-lan="html:close">关闭</button>
            </div>
        </div>
    </div>
</div>
```


```javascript
function doExportExcel(){
    // 判断导出条数是否超过1000,走导出任务
    const totalRows = $('#table01').bootstrapTable('getOptions').totalRows;
    if (totalRows > 0) {
        var keyNumbers = $table.getAllSelections().map(function (i) {
            return i.bowcId
        });
        //判断文本框参数长度是否大于5000
        if (keyNumbers.length > 0 || totalRows < 1000) {
            var progressData = progressOpen();
            var formData = getParamsByqueryForm({});
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "exportExcel", true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8')
            xhr.responseType = "blob";
            xhr.send($.param(formData));
            xhr.onload = function () {
                if (xhr.status === 200) {
                    var contentType = xhr.getResponseHeader("Content-Type");
                    var contentDisposition = xhr.getResponseHeader("Content-Disposition");
                    var blob = new Blob([xhr.response], {type: contentType});
                    var link = document.createElement("a");
                    link.href = window.URL.createObjectURL(blob);
                    link.download = contentDisposition.split("=")[1];
                    link.click();
                    //关闭进度条
                    progressClose(progressData);
                    $("#bowcIdList").val("");
                    $('#exportConfirmModal').modal("hide");
                } else {
                    progressClose(progressData);
                    $.jGrowl(get_lan('pleaseReoperate'));//请求失败，请重新操作！
                }
            };
        } else {
            exportTaskData();
            $('#exportConfirmModal').modal("hide");
        }
    }

}


function exportTaskData() {
    var formText = getFormText();
    $('#exportTaskInfo').html(formText);
    $('#exportTaskDataModal').modal('show');
}

function getFormText() {
    var formText = "";
    $.each($('#queryForm'), function (index, queryForm) {
        var $queryForm = $(queryForm)[index];
        $.each($queryForm, function (index, ele) {
            $ele = $(ele);
            if ($ele[0].nodeName == 'INPUT') {
                if ($ele.attr("type") == 'text' && $ele.attr("class").indexOf("form-control") != -1) {
                    //文本
                    var inputName = $ele.prev().text();
                    var inputVal = $ele.val();
                    if (inputName != "") {
                        if (inputVal.length > 30) {
                            inputVal = inputVal.substring(0, 30) + "...";//超过30位隐藏
                        }
                        formText = formText + inputName + " " + inputVal + "</br>";
                    }
                }
                if ($ele.attr("type") == 'number' && $ele.attr("class").indexOf("form-control") != -1) {
                    //文本
                    var inputName = $ele.prev().text();
                    var inputVal = $ele.val();
                    var endVal = $ele.next().val();
                    if (inputName != "") {
                        if (inputVal.length > 30) {
                            inputVal = inputVal.substring(0, 30) + "...";//超过30位隐藏
                        }
                        formText = formText + inputName + " " + inputVal + "~" + endVal + "</br>";
                    }
                }
                if ($ele.attr("type") == 'radio' && $ele.attr("checked") == 'checked') {
                    //文本
                    var inputName = $ele.prev().text();
                    var inputVal = $ele.next().text();
                    formText = formText + inputName + " " + inputVal + "</br>";
                }
            } else if ($ele[0].nodeName == 'SELECT') {
                var selectName = $ele.prev().text();
                var selectVal = '';
                $.each($ele.find("option:selected"), function (index, ele) {
                    if (index != 0) {
                        selectVal += ",";
                    }
                    selectVal += $ele.find("option:selected")[index].innerText;
                })
                //下拉框
                formText = formText + selectName + " " + selectVal + "</br>";
            }
        });
    });
    return formText;
}


// 导出任务
function doExportTaskData() {
    const exportBtnId = 'exportBtn';
    lockButton(exportBtnId);
    var modularName = document.getElementsByTagName('title')[0].innerText;
    var buttonName = document.getElementById(exportBtnId).innerText;
    var params = {};
    var queryForm = $('#queryForm').serializeArray();
    for (var i = 0; i <  queryForm.length; i++) {
        if (params[queryForm[i]['name']]) {
            params[queryForm[i]['name']] = params[queryForm[i]['name']] + ',' + queryForm[i]['value'];
        } else {
            params[queryForm[i]['name']] = queryForm[i]['value'];
        }
    }
    var content = JSON.stringify(params);
    var data = {
        "taskName": `${modularName}_${buttonName}`,
        "taskModular": modularName,
        "taskParameter": content
    }
    //打开进度条
    var progressData = progressOpen();
    $.ajax({
        url: "/report/exportTask/insertExportTaskEmpower",
        data: JSON.stringify(data),
        method: "POST",
        dataType: "json",
        contentType: "application/json;charset=utf-8",
        async: true,
        success: function (data) {
            //关闭进度条
            unlockButton(exportBtnId);
            progressClose(progressData);
            $.jGrowl(data.message);
            $('#exportTaskDataModal').modal("hide");
            $('#exportTaskLinkCode').html(data.data);
            $('#exportTaskLinkModal').modal("show");
        },
        error: function () {
            //关闭进度条
            unlockButton(exportBtnId);
            progressClose(progressData);
            $.jGrowl(get_lan('serviceRequestFailed'));//服务请求失败
        }
    });
}
function linkExportTask() {
    var tabName = get_lan('exportTask');
    tabmenu.openTab($('#exportTaskLinkCode').text(), get_lan('exportTask','导出任务'), "/report/exportTask/list?taskCode=" + $('#exportTaskLinkCode').text());
}
// 锁定操作按钮
function lockButton(idName) {
    $("#" + idName).prop("disabled", true);
    // 添加延时器，10秒后自动解锁
    setTimeout(function () {
        unlockButton(idName);
    }, 10000);
}
function unlockButton(idName) {
    setTimeout(function () {
        $("#" + idName).prop("disabled", false);
    }, 500);
}
```



```sql
-- 删除客户WPPG的卸柜费成本明细
DELETE FROM wpglb_fms.bfi_operation_cost_container_detail WHERE customer_code = 'WPPG';

-- 临时表只存主键和新值
CREATE TABLE tmp_revenue_update (
    id BIGINT PRIMARY KEY,
    new_ship_time DATETIME
);

-- 物流收入，退件标签补充出库时间
INSERT INTO tmp_revenue_update (id, new_ship_time)
SELECT lr.lr_id, so.spo_arrival_time
FROM logistics_revenue lr
JOIN special_orders so ON so.spo_code = lr.order_code
WHERE lr.order_type = 2 AND lr.ship_time IS NULL;

-- 物流收入，承运商退件补充出库时间
INSERT INTO tmp_revenue_update (id, new_ship_time)
SELECT lr.lr_id, ws.scanning_time
FROM logistics_revenue lr
JOIN warehouse_scanning ws ON ws.scanning_code = lr.order_code
WHERE lr.order_type = 5 AND lr.ship_time IS NULL;

-- 物流收入，代卖补充出库时间
INSERT INTO tmp_revenue_update (id, new_ship_time)
SELECT lr.lr_id, dod.finish_time
FROM logistics_revenue lr
JOIN delivery_order dod ON dod.delivery_order_code = lr.order_code
WHERE lr.order_type = 4 AND lr.ship_time IS NULL;

-- 分批更新
UPDATE logistics_revenue lr
JOIN tmp_revenue_update t ON lr.lr_id = t.id
SET lr.ship_time = t.new_ship_time
WHERE lr.id BETWEEN ? AND ?;

```