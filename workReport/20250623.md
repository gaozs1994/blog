wpglb-bms：develop/finance-费用精细化(新)
westernpost-wms：develop/finance-2025.07.17


(一)财务&渠道迭代
任务 1：【BMS-费用精细化】物流来账成本展示来账明细。
    a. 按来账模板中费用类型的账单模板字段进行费用项明细展示。
任务 2：财务7月迭代一-需求评审。
任务 3：财务6月迭代二-代码评审。
任务 4：【WMS-报表中心- 所有收入模块】页面审核提速-开发设计。
任务 5：【OMS/WMS-物流索赔/库内索赔】索赔原因及其他调整-开发设计。
    a. 梳理需求，整理多个需求不明确的点，并及时反馈给产品进行确认。
任务 6：【WMS-海外仓账单管理】审核优化，汇总页解析空行错误提示。

(一)日常工作
任务 1：【FMS物流成本】推凭后存在多条成功回调导致成本翻倍。
    原因：排查只推凭了一次，但回调接口接收到多次成功的请求数据，导致生成多条重新预估成本明细。
    解决过程：反馈相关外部对接人员(阳子杰)。回调接口幂等处理，多次成功回调只会生成一条重新预估成本。
任务 2：【FMS物流成本】跑数任务查询来账表切换BMS库，测试费用精细化是否影响跑数。




```sql

```

- 物流索赔管理
    - 新增操作
        - 代码入口：com.westernpost.oms.web.fee.ClaimApplicationController#addClaimApplication
        - 添加索赔原因，上网异常、其他
        - 索赔原因=其他，新增必填项：产品索赔金额、单据号、仓库代码，删除货物价格总和


1. 【OMS-物流索赔管理】新增 / 修改 索赔单弹窗中索赔原因调整：新增下拉枚举“上网异常”和“其他”。
    1. 添加物流索赔(LOGISTIC_CLAIM)原因枚举值(westernfulfill.sys_page_constant) 注意：物流索赔原因取constant_value
    2. 新增/编辑操作
        1. 索赔原因选择“其他”时，新增必填项：产品索赔金额(货物价格总和)、单据号(订单号)、仓库代码(仓库ID)
        2. 索赔原因选择“上网异常”时，新增必填项：产品索赔金额(货物价格总和)、单据号(订单号)、仓库代码(仓库ID)
        3. 新增实际发货时间字段，记录订单的发货时间。
        4. 对应的资料要求，按强哥提供的资料文件进行替换。
    3. OMS导入模板涉及索赔原因下拉选项更新，需要同步调整,历史模板因枚举调整会报错,如何解决？按新模板解析，异常正常报错
2. 【OMS-库内索赔管理】新增 / 修改 索赔单弹窗索赔原因及列表“索赔原因”筛选框枚举值调整
    1. 添加/更新库内索赔原因(WAREHOUSE_REASON_CLAIM)枚举值(westernfulfill.sys_page_constant) 注意：库内索赔原因取constant_id
    2. OMS导入模板涉及索赔原因下拉选项更新，需要同步调整，历史模板因枚举调整会报错,如何解决？按新模板解析，异常正常报错
    3. 删除未上网、多标签，涉及历史数据咋处理？不处理。
    4. 未上网迁移到物流索赔？迁移方案？不迁移，原始需求是物流索赔原因为上网异常时，需匹配库内索赔原因未上网的数据(待受理/处理中/已解决/已赔付/异常)，避免重复索赔。
3. 以上的枚举值需做成支持快速调整
    1. 库内索赔原因取的是枚举ID，物流索赔原因取的是枚举值，可以快速调整展示文本，新增枚举，导入模板需要更新。
4. 【WMS-库内索赔管理】列表“受理中” 和“已退回”“售后导入审核”模板字段先后顺序调整。
    1. 受理中、已退回标签，售后导入审核按钮，导入模板调整顺序。
    2. 因导入解析是按列号顺序解析，考虑兼容历史模板需要代码重构，按列名去解析。
5. 【WMS-物流索赔管理】[已提交]“批量导入结果”模板更改增加数据导入
    1. 导入模板调整，新增“货物价值”、"发货运费" 、“库内操作费”，删除“实际赔偿金额”，历史模板是否需要兼容？按新模板解析，异常正常报错
    2. 因按列号顺序逐列解析，重构代码逻辑，按列名解析。
    3. 新建物流索赔单费用表，记录实际赔偿金额的赔付费项 “货物价值”、"发货运费" 、“库内操作费”。
    4. 更新物流索赔表，“实际赔偿总金额” = 赔付费项合计。
    5. 新增操作日志：批量导入结果
6. 【WMS-物流索赔管理】[已处理][已赔付] 增加"合作仓受理"数据导入，根据索赔编号导入对应的合作仓受理数据。
    1. 按钮是否需要加权限？处理逻辑是否跟库内索赔的合作仓受理逻辑一致？添加权限，参照库内索赔导入合作仓受理逻辑
    2. 导入字段为"索赔编号"、"合作仓赔付货物价值"、"合作仓赔付发货运费"、"合作仓赔付库内操作费"、"合作仓赔付备注"，除了"索赔编号"其他数据都可为空。
    3. 物流索赔单费用表上，新增上述费用项。
    4. 在物流索赔表，新增“合作仓赔付备注”字段，并更新。
    5. 新增操作日志：上传合作仓受理成功。
7. 【WMS-物流索赔管理】页面显示数据以及导出数据增加以及更改。
    1. 所有页签都增加实际出账金额、赔付费项、合作仓赔付费项总项、实际发货时间、实际赔偿金额改为实际赔偿总金额
    2. 实际出账金额：发货运费、库内操作费。
        1. 实际出账金额，来自账单解析logistics_claim_parser。
        2. 发货运费，来自物流费用logistics_fee_order_parser_flow.bill_analysis_amount，按订单号+跟踪号匹配,并groupby，(只有流水表有跟踪号维度的账单金额数据)
        3. 库内操作费，来自出库费用warehouse_fee.flow_total_amount，按订单号匹配。
    3. 赔付费项：货物价值、货物运费、库内操作费
    4. 合作仓赔付费项：货物价值、货物运费、库内操作费
    5. 实际赔偿总金额：批量导入结果的赔付费项的合计
    6. 导出字段同步更改。
8. 【WMS-物流索赔管理】[受理中]增加退回功能
    1. 受理中，退回操作。
    2. 待处理->受理中，只更新索赔表的状态，以及新增反馈记录、操作日志。

